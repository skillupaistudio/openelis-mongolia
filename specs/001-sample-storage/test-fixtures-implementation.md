# Test Fixtures Implementation - Generated SQL Approach

**Status**: ✅ Implemented (2025-12-16)  
**Issue**: Storage E2E tests require Maven in CI (frontend-qa.yml)  
**Solution**: Generate SQL on-demand from authoritative DBUnit XML

---

## Problem Statement

The storage feature uses a well-designed 3-layer test data architecture:

| Layer             | Purpose                    | Format     |
| ----------------- | -------------------------- | ---------- |
| 1 (Foundation)    | Schema + baseline ref data | Liquibase  |
| 2 (Feature)       | E2E fixtures               | DBUnit XML |
| 3 (Test-specific) | Dynamic data               | Builders   |

**The Issue**: Layer 2 (DBUnit XML) could only be loaded via Java/DBUnit,
requiring Maven in E2E CI:

- ✅ **Backend tests**: `BaseStorageTest` →
  `executeDataSetWithStateManagement("storage-e2e.xml")` (Java/DBUnit)
- ❌ **E2E tests**: `cy.loadStorageFixtures()` → `load-test-fixtures.sh` →
  `mvn exec:java DbUnitFixtureLoader` (required Maven + dataexport submodule in
  `frontend-qa.yml`)

---

## Solution: Generated SQL with Single Source of Truth

**Principle**: DBUnit XML remains the **authoritative source**, but we generate
SQL on-demand for non-Java environments.

```
src/test/resources/testdata/
├── storage-e2e.xml           # AUTHORITATIVE (edit this)
├── storage-e2e.generated.sql # DERIVED (generated on-the-fly, never committed)
└── xml-to-sql.py             # Converter script
```

### Workflow

1. **Authoritative Source**: `storage-e2e.xml` (DBUnit XML) - all edits go here
2. **On-Demand Generation**: `load-test-fixtures.sh` runs `xml-to-sql.py` before
   loading
3. **E2E Loading**: Generated SQL loaded via `psql` (no Maven needed)
4. **Backend Loading**: Original XML loaded via DBUnit (unchanged)
5. **Git Safety**: `*.generated.sql` files ignored via `.gitignore` (prevents
   accidental commits)

### Benefits

✅ **Single source of truth** - DBUnit XML is authoritative  
✅ **No Maven in E2E CI** - SQL loads via `psql` directly  
✅ **Fast CI** - No compilation step, just psql  
✅ **No drift** - SQL regenerated every run from XML  
✅ **Consistent across test types** - Backend (XML) and E2E (generated SQL) use
same data

---

## Implementation Details

### 1. XML to SQL Converter (`xml-to-sql.py`)

**Location**: `src/test/resources/testdata/xml-to-sql.py`

**Features**:

- Parses DBUnit XML using Python's `xml.etree.ElementTree`
- Handles NULL values (empty string in XML → `NULL` in SQL)
- Proper type detection (booleans, numbers, strings)
- Quote escaping for string values
- Generates PostgreSQL-compatible INSERT statements

**Usage**:

```bash
python3 xml-to-sql.py storage-e2e.xml storage-e2e.generated.sql
```

**Output** (89 INSERT statements from storage-e2e.xml):

```sql
-- Generated from: storage-e2e.xml
-- DO NOT EDIT - This file is auto-generated from DBUnit XML
-- Generated by: xml-to-sql.py

INSERT INTO storage_room (id, fhir_uuid, name, code, ...) VALUES (...);
INSERT INTO storage_device (id, fhir_uuid, name, code, ...) VALUES (...);
-- ... 87 more statements
```

### 2. Modified `load-test-fixtures.sh`

**Changes**:

- ❌ Removed: Maven dependency check
- ❌ Removed: `mvn test-compile` step
- ❌ Removed: `mvn exec:java -Dexec.mainClass=DbUnitFixtureLoader`
- ✅ Added: Python 3 dependency check
- ✅ Added: On-demand SQL generation step
- ✅ Added: Direct `psql` loading (Docker and direct connection modes)

**Key Section**:

```bash
# Generate SQL from DBUnit XML (on-demand, never committed)
echo "Generating SQL from DBUnit XML..."
python3 "$XML_TO_SQL_SCRIPT" "$STORAGE_XML" "$STORAGE_SQL"

# Load via psql (Docker mode)
docker exec -i openelisglobal-database psql -U clinlims -d clinlims < "$STORAGE_SQL"

# OR Load via psql (direct mode)
psql -U "$DB_USER" -d "$DB_NAME" -h "$DB_HOST" -p "$DB_PORT" -f "$STORAGE_SQL"
```

### 3. Git Safety (`.gitignore`)

**Added**:

```gitignore
# Generated test fixtures (derived from DBUnit XML, never commit)
# These are generated on-the-fly during test runs from authoritative XML sources
src/test/resources/testdata/*.generated.sql
```

**Verification**:

```bash
$ git status src/test/resources/testdata/storage-e2e.generated.sql
# Not tracked (correctly ignored)

$ git check-ignore -v src/test/resources/testdata/storage-e2e.generated.sql
.gitignore:66:src/test/resources/testdata/*.generated.sql
```

### 4. Updated Documentation

**Files Updated**:

- `src/test/resources/testdata/README.md` - Added "Generated SQL Files (E2E
  Tests Only)" section
- `src/test/resources/load-test-fixtures.sh` - Updated header comments and error
  messages
- `.gitignore` - Added generated SQL pattern

---

## Testing the Implementation

### Manual Test

```bash
# Clean any existing generated SQL
rm -f src/test/resources/testdata/storage-e2e.generated.sql

# Run the fixture loader (should generate SQL on-demand)
bash src/test/resources/load-test-fixtures.sh

# Verify SQL was generated (89 INSERT statements)
wc -l src/test/resources/testdata/storage-e2e.generated.sql
# Output: 93 (89 INSERTs + 4 header comments)

# Verify git ignores it
git status src/test/resources/testdata/storage-e2e.generated.sql
# Output: (no output - correctly ignored)
```

### CI Test

The `frontend-qa.yml` workflow no longer needs:

- ❌ Java 21 setup
- ❌ Maven installation
- ❌ `dataexport` submodule build
- ❌ `mvn test-compile` step

Now it only needs:

- ✅ Python 3 (already available in GitHub Actions Ubuntu runners)
- ✅ PostgreSQL client (`psql`) - already available

---

## Migration Guide (If Editing Fixtures)

### Before (Old Approach)

1. Edit `storage-e2e.xml`
2. Backend tests automatically pick up changes (DBUnit)
3. E2E tests required Maven rebuild in CI

### After (New Approach)

1. Edit `storage-e2e.xml` (same as before)
2. Backend tests automatically pick up changes (DBUnit, unchanged)
3. E2E tests automatically pick up changes (SQL regenerated on-demand)
4. **No manual SQL editing needed** - XML is authoritative

### Important Rules

✅ **DO**: Edit `storage-e2e.xml` when adding/modifying test fixtures  
✅ **DO**: Let the system generate SQL automatically  
❌ **DON'T**: Edit `*.generated.sql` files directly (they're regenerated every
run)  
❌ **DON'T**: Commit `*.generated.sql` files to git (`.gitignore` prevents this)

---

## Advantages Over Alternatives

| Approach                     | Single Source?         | CI Complexity            | Speed        | Result                   |
| ---------------------------- | ---------------------- | ------------------------ | ------------ | ------------------------ |
| **A. Maven in E2E CI**       | ✅ XML                 | High (Java + dataexport) | Slow (+2min) | ❌ Rejected              |
| **B. Separate SQL file**     | ❌ Two files           | Low                      | Fast         | ❌ Rejected (drift risk) |
| **C. Generated SQL** ⭐      | ✅ XML (authoritative) | Low (Python)             | Fast (<1s)   | ✅ **Selected**          |
| **D. Node.js DBUnit loader** | ✅ XML                 | Medium (new code)        | Fast         | ❌ Overengineered        |

---

## Files Modified

### Created

- `src/test/resources/testdata/xml-to-sql.py` - XML→SQL converter (executable)
- `src/test/resources/testdata/.gitkeep` - Keep directory in git
- `specs/001-sample-storage/test-fixtures-implementation.md` - This document

### Modified

- `.gitignore` - Added `src/test/resources/testdata/*.generated.sql` pattern
- `src/test/resources/load-test-fixtures.sh` - Replaced Maven approach with
  Python generation
- `src/test/resources/testdata/README.md` - Documented generated SQL workflow

### Not Modified (Backend Tests Unaffected)

- `src/test/java/org/openelisglobal/storage/BaseStorageTest.java` - Still loads
  XML via DBUnit
- `src/test/java/org/openelisglobal/BaseWebContextSensitiveTest.java` - DBUnit
  loading logic unchanged
- `src/test/resources/testdata/storage-e2e.xml` - Remains authoritative source

---

## Next Steps

1. **Remove Maven from `frontend-qa.yml`** - No longer needed for fixture
   loading
2. **Test E2E suite in CI** - Verify fixtures load correctly via generated SQL
3. **Clean up `DbUnitFixtureLoader.java`** - Optional: can be removed if no
   longer used elsewhere

---

**Implemented By**: AI Agent  
**Date**: 2025-12-16  
**Related Issue**: Storage E2E tests fail in CI due to Maven dependency  
**Historical Analysis**: See [test-data-strategy.md](./test-data-strategy.md)
for background research

---

## Related Documentation

- **Feature-Specific**:
  - [test-data-strategy.md](./test-data-strategy.md) - Historical analysis that
    led to this implementation
  - [data-model.md](./data-model.md) - Storage entity relationships
  - [quickstart.md](./quickstart.md) - Developer onboarding guide
- **General Patterns**:
  - [src/test/resources/testdata/README.md](../../src/test/resources/testdata/README.md) -
    DBUnit XML dataset conventions
  - [.specify/guides/testing-roadmap.md](../../.specify/guides/testing-roadmap.md) -
    Testing strategy and patterns
